<!DOCTYPE html>
<html>
<head>

  <script src="../node_modules/jsclass/src/loader-browser.js"></script>
  <script src="../node_modules/date-utils/lib/date-utils.js"></script>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<link rel="stylesheet" href="versiontracker.css">

<!-- Optional theme -->
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

  <script type="text/javascript">


    JS.packages(function() { with(this) {
      file('../versiontracker.js')
        .provides('versiontracker', 'Collection', 'Version', 'Sprint')
        .requires('JS.Class', 'JS.Enumerable', 'JS.Comparable', '_', 'Handlebars', 'jQuery');

      file('//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js')
        .provides('jQuery');

      file('//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js')
        .provides('_');

      file('//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.2/handlebars.min.js')
        .provides('Handlebars');
    }});

    JS.require('versiontracker', function() {
      var versions = new Collection()

      versions.add(new Version("Relaunch 1.1", "2014-08-28", 41+17*13))
      versions.add(new Version("Relaunch 1.0", "2014-06-05", 421-40))
      versions.add(new Version("Homepage 2.0", "2014-06-05", 50))
      versions.add(new Version("Product Finder 1.0", "2014-06-05", 91+3*13))
      versions.add(new Version("User Library 1.1", "2014-04-24", 136+5*13))



      var sprints = new Collection()
      var _first = new Date("2014-02-24");

      // Need at least so many sprints to cover all versions
      for (var i = 4; i < 12; i++) {
        var start_date = _first;
        if(sprint) {
          start_date = new Date(sprint.ends)//.addDays(3)
        }
        var sprint = new Sprint("v2."+i+".0", start_date);
        sprints.add(sprint);
      }

    Handlebars.registerHelper("debug", function(optionalValue) {
      console.log("\nCurrent Context");
      console.log("====================");
      console.log(this);

      if (arguments.length > 1) {
        console.log("Value");
        console.log("====================");
        console.log(optionalValue);
      }
    });

    Handlebars.registerPartial("version", $("#version-partial").html());
    Handlebars.registerPartial("sprint", $("#sprint-partial").html());
    Handlebars.registerHelper('simpleDate', function(date) {
      return date.toFormat('MMM D')
    });
    Handlebars.registerHelper('duration', function(date) {
      return this.last_sprint.index - this.first_sprint.index + 1
    });

    function init(e) {
      $("#content").html('loadingâ€¦');
      var vt = versiontracker()
      vt.init(sprints, versions);
      vt.solve();
      var version_src = $("#version-template").html();
      var version_tpl = Handlebars.compile(version_src);
      var table = {versions: versions, sprints: sprints}
      $("#content").html(version_tpl(table));

    }
    $( document ).ready(function() {
      $( "#run" ).click(init);
      init();
    });



    });
  </script>
</head>
<body>
<script id="version-template" type="text/x-handlebars-template">
<div class="panel panel-default">
  <div class="panel-heading">Versions</div>
  <div class="panel-body">
  {{#versions._list}}
    {{> version}}
  {{/versions._list}}
    <div class="row">
      <div class="col-md-2">Sprint</div>
      {{#sprints._list}}
        {{> sprint}}
      {{/sprints._list}}
    </div>
  </div>
</div>

<div class="container">
<ul class="list-group">
{{#versions._list}}
  <li class="list-group-item">
    <span class="badge">{{this.getInitialStoryPoints}}</span>
    <span class="badge">{{this.getCurrentStoryPoints}}</span>
    <h5>{{name}}</h5>
    {{simpleDate ends}}<br>
    First Sprint {{first_sprint.name}} starting {{simpleDate first_sprint.starts}} #{{first_sprint.index}}<br>
    Last Sprint {{last_sprint.name}} ending {{simpleDate last_sprint.ends}} #{{last_sprint.index}} {{duration this}}
    </li>
{{/versions._list}}
</ul>
</div>
</script>
<script id="version-partial" type="text/x-handlebars-template">
  <div class="row">
    <div class="col-md-2">{{name}}</div>
    <div class="col-md-{{duration this}} col-md-offset-{{first_sprint.index}}">
      <div class="progress">
        <div class="progress-bar" role="progressbar" style="width: 100%;">
        <span class="sr-only">100</span>
        </div>
      </div>
    </div>
  </div>
</script>
<script id="sprint-partial" type="text/x-handlebars-template">

    <div class="col-md-1">
    {{name}}
    </div>
</script>

<div class="container" id="content"></div>
<button type="button" class="btn btn-default" id="run">Do it</button>



</body>
</html>
